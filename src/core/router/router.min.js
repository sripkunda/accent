(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):(global=typeof globalThis!=="undefined"?globalThis:global||self,global.Accent=global.Accent?(()=>{return Object.assign(global.Accent,factory())})():factory())})(this,function(){"use strict";class Router{static app=undefined;routes;currentRoute;currentPath;defaultPane;#routerCache={};params={};constructor(routes,args={}){if(Router.app)throw Error(_AccentRouterErrors.ROUTER_ALREADY_RUNNING());const pane=args.pane;const async=args.loadPagesAsync;(async()=>{this.routes=typeof routes==="object"?routes:await Router.#fetch(routes,"json").then(routes=>{document.dispatchEvent(_AccentRouterEvents.ROUTES_RECOGNIZED);return routes});this.defaultPane=pane;await Router.route(this,location.pathname,true,pane);this.#beginNavigation();if(!(async==false)){this.#cachePagesAsync().then(v=>{document.dispatchEvent(v)})}document.dispatchEvent(_AccentRouterEvents.ROUTER_INIT)})();Router.app=this}async#beginNavigation(){window.addEventListener("popstate",event=>{Router.route(this,window.location.pathname,true)})}async#cachePagesAsync(){return await new Promise((res,rej)=>{const routes=Object.keys(this.routes);routes.forEach(async(r,i)=>{if(this.routes[r].load==_AccentRouteLoadTypes.LOAD_LAZY||this.routes[r].load==_AccentRouteLoadTypes.LOAD_UNCACHED)return;this.#routerCache[r]={name:r,html:await this.#fetchPageAsync(r)};if(routes.length==i+1)res(_AccentRouterEvents.ROUTES_LOADED_ASYNC)})}).then(v=>{return v})}async fillPane(destination,isRoot,parameters,targetPane,childPane){targetPane=targetPane||document.querySelector(`${_AccentRouterConfig.ROUTER_PANE_TAGNAME}`);if(!targetPane)throw Error(_AccentRouterErrors.TARGET_NOT_FOUND(destination));if(!childPane)this.defaultPane=targetPane;const cache=this.#routerCache?this.#routerCache[destination]:undefined;if(childPane){const route=Router._getRouteFromInput(this,`${this.currentPath}${destination}`);if(this.currentPath!=route.destination)await Router.route(this,route.destination,false);this.params=route.dynamics;return window.history.pushState({content:"",title:document.title},document.title,`${this.currentPath}${destination}`)}const route=await(async()=>{return cache?.html?cache:await this.#fetchPage(destination??this.routes)})();const doc=(new DOMParser).parseFromString(route.html,"text/html");let path=Array.isArray(this.routes[route.name]["path"])?this.routes[route.name]["path"][0]:this.routes[route.name]["path"];path=path.replace(_AccentRouterConfig.ROUTER_DYNAMIC_LINK,(_a,b)=>{return`${parameters?parameters[b]?`${parameters[b]}/`:"":""}`});this.currentPath=path;this.params=parameters||{};const content={content:"",title:doc.title};isRoot?window.history.replaceState(content,doc.title,path):window.history.pushState(content,doc.title,path);if(doc.title)document.title=doc.title;targetPane.innerHTML="";const toAppend=doc.querySelector(`${_AccentRouterConfig.ROUTER_TARGET_TAGNAME}`)||doc.body;if(!toAppend){throw _AccentRouterErrors.TARGET_NOT_FOUND(route.name)}const prot=toAppend.getAttribute(_AccentRouterConfig.ROUTER_PROTECT_DIRECTIVE);const fallback=toAppend.getAttribute(_AccentRouterConfig.ROUTER_FALLBACK_DIRECTIVE);if(prot&&!(typeof RendererLibrary!=="undefined"&&Accent.Renderer.compiler._executeInContext(`return ${prot}`,AccentContext.find(targetPane),["$params"],[this.params])||Function("$params",`return ${prot}`)(this.params))){if(fallback)return Router.route(this,fallback);else throw _AccentRouterErrors.UNPROTECTED_ROUTE(route.name)}targetPane.innerHTML=toAppend.innerHTML;doc.querySelectorAll("link[rel=stylesheet], style").forEach(s=>targetPane.append(s));this.currentRoute=route.name;this.#executeScripts(doc,route.name);this.#executeScripts(targetPane,route.name);this.configureRoutingLinks();if(typeof ComponentsLibrary!=="undefined"){const handler=typeof RendererLibrary!=="undefined"?()=>{Accent.Renderer.compiler.transpile(targetPane)}:()=>{};Accent.Components.compiler.transpile(targetPane).then(handler)}else if(typeof RendererLibrary!=="undefined"){Accent.Renderer.compiler.transpile(targetPane)}}async#fetchPage(routes){return await new Promise((res,rej)=>{if(typeof routes==="object"){Object.keys(routes).forEach(async(route,i)=>{const path=routes[route]["path"];if(path=="/"||Array.isArray(path)&&path.includes("/")){res(route)}});res()}else{res(routes)}}).then(async data=>{if(!data)data=Object.keys(this.routes)[0];const json={name:data,html:await this.#fetchPageAsync(data)};if(!(this.routes[data].load==_AccentRouteLoadTypes.LOAD_UNCACHED))this.#routerCache[data]=json;return json})}async#fetchPageAsync(route){try{const path=this.#formatPath(`${this.routes[route]["src"]}`);return await Router.#fetch(path,"html")}catch{throw _AccentRouterErrors.SOURCE_NOT_FOUND(route)}}async#executeScripts(doc,route){doc.querySelectorAll("script").forEach(async el=>{const src=el.getAttribute("src");const path=src?this.#formatPath(src):undefined;try{let content;if(path?.trim()){content=this.#routerCache[route][path]??await(await fetch(path)).text();if(!(this.routes[route].load==_AccentRouteLoadTypes.LOAD_UNCACHED))this.#routerCache[route][path]=content}else{content=el.innerHTML}if(content)(0,eval)(content)}catch(err){throw _AccentRouterErrors.BASE_ERROR(`${path||this.routes[route]["src"]}: ${err}`)}})}configureRoutingLinks(handler){document.querySelectorAll(`[${_AccentRouterConfig.ROUTER_LINK_DIRECTIVE}]`).forEach(el=>{const href=el.getAttribute(`${_AccentRouterConfig.ROUTER_LINK_DIRECTIVE}`);if(!href)return;if(el["__route__"])return;el.onclick=handler?event=>{handler(event,href)}:event=>{event.preventDefault();Router.route(this,href,false,this.defaultPane)};el["__route__"]=true})}#formatPath(path){return`//${window.location.host.replace(/\/$/,"")}/${path}`.replace(/\/?$/,"")}static async#fetch(path,type){return await fetch(path).then(async response=>{if(!response.ok){throw Error()}switch(type.toLowerCase()){case"json":return response.json();case"html":const html=await response.text();return html}}).catch(err=>{throw _AccentRouterErrors.SOURCE_NOT_FOUND(path)})}async route(...args){Router.route(this,...args)}static async route(router,destination,root,pane=this.defaultPane){document.dispatchEvent(_AccentRouterEvents.ROUTING_STARTED);const route=Router._getRouteFromInput(router,destination);await router.fillPane(route.destination,root,route.dynamics,pane).then(v=>{document.dispatchEvent(_AccentRouterEvents.ROUTING_ENDED)}).catch(e=>{document.dispatchEvent(_AccentRouterEvents.ROUTING_FAILED);throw e})}static _getRouteFromInput(router,destination){destination=destination.replace(/\/$/,"");if(router.routes[destination]){return{destination:destination}}else{try{const destinationFrags=destination.split("/");let p;let dynamics;Object.keys(router.routes).every(r=>{dynamics={};const frags=[...destinationFrags];const path=router.routes[r].path;const pathFrags=Array.isArray(path)?path.map(d=>d.split("/")):path.split("/");return pathFrags.every((exec,i)=>{let exp;const cleanFrags=(exec,pathIndex)=>{while(exp=_AccentRouterConfig.ROUTER_DYNAMIC_LINK_ISOLATED.exec(exec)){const index=pathIndex-(destinationFrags.length-frags.length);if(frags[index])dynamics[exp[1]]=decodeURI(frags[index]);frags.splice(index,1)}};if(Array.isArray(exec)){exec.forEach((e,i)=>{cleanFrags(e,i)})}else{cleanFrags(exec,i)}let formattedPath=Router.#formatDynamicRouterPath(path);formattedPath=Array.isArray(formattedPath)?formattedPath.map(p=>p.replace(/\/$/,"")):formattedPath.replace(/\/$/,"");const formattedDestination=frags.join("/").replace(/\/$/,"");if(formattedPath==formattedDestination||Array.isArray(formattedPath)&&formattedPath.includes(formattedDestination)){p=r;return false}return true})});return{destination:p,dynamics:dynamics}}catch{throw _AccentRouterErrors.ROUTE_NOT_DETERMINED()}}}static#formatDynamicRouterPath(path){return Array.isArray(path)?path.map(p=>p.replace(_AccentRouterConfig.ROUTER_DYNAMIC_LINK,"")):path.replace(_AccentRouterConfig.ROUTER_DYNAMIC_LINK,"")}}const $route=Router.route;const $link=(router,el,destination)=>{el.onclick=e=>{e.preventDefault();Router.route(router,destination)}};const _AccentRouterConfig={ROUTER_DYNAMIC_LINK:/:(.+?)\//g,ROUTER_DYNAMIC_LINK_ISOLATED:/:(.+)/g,ROUTER_PANE_TAGNAME:`router-pane`,ROUTER_TARGET_TAGNAME:`router-target`,ROUTER_LINK_DIRECTIVE:`router-to`,ROUTER_PROTECT_DIRECTIVE:`router-protect`,ROUTER_FALLBACK_DIRECTIVE:`router-fallback`,EVENT_PREFIX:`router:`};const _AccentRouterEvents={ROUTES_RECOGNIZED:new Event(`${_AccentRouterConfig.EVENT_PREFIX}routes-recognized`),ROUTER_INIT:new Event(`${_AccentRouterConfig.EVENT_PREFIX}router-init`),ROUTING_STARTED:new Event(`${_AccentRouterConfig.EVENT_PREFIX}routing-started`),ROUTING_ENDED:new Event(`${_AccentRouterConfig.EVENT_PREFIX}routing-ended`),ROUTES_LOADED_ASYNC:new Event(`${_AccentRouterConfig.EVENT_PREFIX}routes-loaded-async`),ROUTING_FAILED:new Event(`${_AccentRouterConfig.EVENT_PREFIX}routing-failed`)};const _AccentRouteLoadTypes={LOAD_LAZY:"lazy",LOAD_UNCACHED:"uncached",LOAD_ASYNC:"async"};const _AccentRouterErrors={AccentLibraryName:`Accent.js Router`,ROUTE_NOT_FOUND:(...params)=>{return`(${_AccentRouterErrors.AccentLibraryName}) The specified route ('${params[0]}') was not found.`},TARGET_NOT_FOUND:(...params)=>{return`(${_AccentRouterErrors.AccentLibraryName}) A router target could not be found for route '${params[0]}'.`},UNPROTECTED_ROUTE:(...params)=>{return`(${_AccentRouterErrors.AccentLibraryName}) The fallback for protected route '${params[0]}' was not found.`},JSON_PARSE:(...params)=>{return`(${_AccentRouterErrors.AccentLibraryName}) The provided JSON input could not be parsed from ${params[0]}.`},ROUTE_NOT_DETERMINED:(...params)=>{return`(${_AccentRouterErrors.AccentLibraryName}) A route could not be determined from the destination '${params[0]}'. Please ensure that the initial routes data and destination are properly formatted.`},SOURCE_NOT_FOUND:(...params)=>{return`(${_AccentRouterErrors.AccentLibraryName}) An error occurred while fetching the source for ${params[0]}.`},ROUTER_ALREADY_RUNNING:(...params)=>{return`(${_AccentRouterErrors.AccentLibraryName}) The main router for this app is already running. Use Accent.js Templates for "child" routes`},BASE_ERROR:e=>{return`(${_AccentRouterErrors.AccentLibraryName}) ${e}`}};const $router=(...args)=>{return new Router(...args)};window.RouterLibrary=true;var router_accent={Router:Router,$link:$link,$route:$route,$router:$router};return router_accent});